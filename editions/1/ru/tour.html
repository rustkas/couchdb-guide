<title>Getting Started</title>

<meta charset="utf-8">

<link rel="stylesheet" href="../../../style.css">

<link rel="prev" href="consistency.html">

<link rel="next" href="api.html">

<script src="../../../script.js"></script>

<h2 id="tour">Начало работы</h2>

<p>
В этой главе мы кратко рассмотрим возможности CouchDB, познакомимся со <em>Futon</em>, встроенным интерфейсом администрирования. Мы создадим наш первый документ и поэкспериментируем с представлениями CouchDB. Прежде чем мы начнем, перейдите к <a href="source.html"> Приложению D, Установка из исходных кодов</a> и найдите подходящее описание установки СУБД CouchDB на операционную систему, которую вы используете. Мы рекомендуем Вам следовать инструкциями и установить её прежде чем вы продолжите чтение книги.
<h3 id="go">Все системы за работу!</h3>

<p>Мы очень быстро рассмотрим базовый <em>Интерфейс прикладного программирования (API) </em> в CouchDB, используя утилиту командной строки <code>curl</code>. Обратите внимание, что это только один из способов общения с CouchDB. Мы покажем вам и другие способоы в остальной части книги. Что интересно в <code>curl</code>, так это то, что он дает вам контроль над необработанными HTTP-запросами, и вы можете точно видеть, что происходит «под капотом» вашей базы данных.
<p>Убедитесь, что CouchDB все еще работает, а затем выполните HTTP-запросам:
<pre>
curl http://127.0.0.1:5984/
</pre>

<p>Это <code>GET</code>-запрос на только что установленный экземпляр СУБД CouchDB.
<p>Ответ должен выглядеть примерно так:

<pre>
{"couchdb":"Welcome","version":"0.10.1"}
</pre>

<p>Нет ничего впечатляющего. CouchDB просто говорит «привет», сообщает номер текущей версии и дополнительну информацию.
<p>Далее мы можем получить список баз данных:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<p>Все, что мы добавили к предыдущему запросу, это строка <code>_all_dbs</code>.
<p>Ответ должен выглядеть так:

<pre>
[]
</pre>

<p>Ах да, мы еще не создали ни одной базы данных! Все, что мы видим, это пустой список.

<div class="aside note">

<p>Команда <code>curl</code> по умолчанию использует <code>GET</code>-запросы. Вы можете отправлять <code>POST</code>-запросы, используя <code>curl -X POST</code>. Чтобы упростить работу с историей наших терминалов, мы обычно используем опцию <code>-X</code> даже при отправке запросов <code>GET</code>. Если мы хотим отправить <code>POST </code> в следующий раз, все, что нам нужно изменить, - это изменить метод <code>GET</code> на <code>POST</code>.
<p>HTTP does a bit more under the hood than you can see in the examples here. If you’re interested in every last detail that goes over the wire, pass in the <code>-v</code> option (e.g., <code>curl -vX GET</code>), which will show you the server <code>curl</code> tries to connect to, the request headers it sends, and response headers it receives back. Great for debugging!
HTTP делает немного больше, чем вы можете видеть в примерах здесь. Если вас интересует более подробная информация, передайте параметр <code>-v </code> (например, <code>curl -vX GET</code>), который покажет вам подключаемый сервер <code>curl</code>, заголовки запроса, которые он отправляет, и заголовки ответа, которые он получает обратно. Это отлично подходит для отладки!
</div>

<p>Давайте создадим базу данных:

<pre>
curl -X PUT http://127.0.0.1:5984/baseball
</pre>

<p>Ответ от CouchDB:

<pre>
{"ok":true}
</pre>

<p>Получение списка баз данных снова показывает обновлённые результаты:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<pre>
["baseball"]
</pre>

<div class="aside note">

<p>Мы должны упомянуть формат данных <em>JavaScript Object Notation (JSON)</em>. CouchDB использует его для обмена данными. JSON - это легкий формат обмена данными, основанный на синтаксисе JavaScript. Поскольку JSON изначально совместим с JavaScript, ваш веб-браузер является идеальным клиентом для CouchDB.
<p>Brackets (<code>[]</code>) represent ordered lists, and curly braces (<code>{}</code>) represent key/value dictionaries. Keys must be strings, delimited by quotes (<code>"</code>), and values can be strings, numbers, booleans, lists, or key/value dictionaries. For a more detailed description of JSON, see <a href="json.html">Appendix E, JSON Primer</a>.
Скобки (<code>[]</code>) представляют упорядоченные списки, а фигурные скобки (<code>{}</code>) представляют словари вида ключ / значение. Ключи должны быть строками, разделенными кавычками (<code>"</ code>), а значения могут быть строки, числа, логические значения, списки или словари ключь / значене. Более подробное описание JSON смотрите на странице <a href = "json.html"> Приложения E, учебник по JSON</a>.
</div>

<p>Давайте создадим другую базу данных:

<pre>
curl -X PUT http://127.0.0.1:5984/baseball
</pre>

<p>Получим ответ от СУБД CouchDB:

<pre>
{"error":"file_exists","reason":"The database could not be created, the file already exists."}
</pre>

<p>У нас уже есть база данных с таким именем, поэтому CouchDB сообщит информацию об ошибке. Давайте попробуем еще раз создать базу данных с другим именем:

<pre>
curl -X PUT http://127.0.0.1:5984/plankton
</pre>

<p>Получим ответ от СУБД CouchDB:

<pre>
{"ok":true}
</pre>

<p>Запросив информацию о существующих базах данных, получим ответ:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<p>Получим ответ от СУБД CouchDB:

<pre>
["baseball", "plankton"]
</pre>

<p>А теперь удалим одну из баз данных:

<pre>
curl -X DELETE http://127.0.0.1:5984/plankton
</pre>

<p>Получим ответ от СУБД CouchDB:

<pre>
{"ok":true}
</pre>

<p>Теперь список баз данных снова содержит название одной базы данных:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<p>Получим ответ от СУБД CouchDB:

<pre>
["baseball"]
</pre>

<p>Для краткости мы пропустим работу с документами, так как в следующем разделе описывается другой и потенциально более простой способ работы с CouchDB. Работая с примером, помните, что «под капотом» все выполняется приложением точно так, как вы делали здесь вручную. Все делается с использованием <code>GET</code>, <code>PUT</code>, <code>POST</code> и <code>DELETE</code> с URI.
<h3 id="welcome">Добро пожаловать в Futon</h3>

<p>After having seen CouchDB’s raw API, let’s get our feet wet by playing with Futon, the built-in administration interface. Futon provides full access to all of CouchDB’s features and makes it easy to work with some of the more complex ideas involved. With Futon we can create and destroy databases; view and edit documents; compose and run MapReduce views; and trigger replication between databases.
После ознакомления с API-интерфейсом CouchDB на низком уровне давайте немного поработаем со встроенным интерфейсом администрирования Futon. Futon обеспечивает полный доступ ко всем функциям CouchDB и облегчает работу с некоторыми более сложными опциями CouchDB. С Futon мы можем создавать и удалять базы данных; просматривать и редактировать документы; составлять и запускать представления MapReduce; и запустить репликацию между базами данных.
<p>Для доступа в Futon, пожалуйста, перейдите по ссылке:

<pre>
http://127.0.0.1:5984/_utils/
</pre>

<p>Если вы используете версию 0.9 или более позднюю, вы должны увидеть нечто похожее на <a href="#figure/1"> Рисунок 1, «Экран приветствия Futon» </a>. В последующих главах мы сосредоточимся на использовании CouchDB при работе с помощью языков программирования на стороне сервера, таких как Ruby и Python. Таким образом, эта глава является прекрасной возможностью продемонстрировать пример собственного обслуживания динамического веб-приложения, использующего не более чем встроенный веб-сервер CouchDB.
<p>Первое, что мы должны сделать при новой установке CouchDB, - запустить тестовый набор, чтобы убедиться, что все работает правильно. Это гарантирует нам, что любые проблемы, с которыми мы можем столкнуться, не связаны с неприятными проблемами с нашей настройкой. Точно так же сбои в тестовом наборе Futon - это красный флаг, который говорит нам о необходимости перепроверить нашу установку, прежде чем пытаться использовать потенциально сломанный сервер базы данных, что избавляет нас от путаницы, когда кажется, что ничего не работает так, как мы ожидаем!
<div class="figure" id="figure/1">

<img src="tour/01.png">

<p class="caption">Рисунок 1. Экран приветствия Futon

</div>

<div class="aside warning">

<p>Некоторые общие конфигурации сети приводят к сбою теста репликации при доступе по адресу <code>localhost</code>. Вы можете исправить это, зайдя в CouchDB через <em>http://127.0.0.1:5984/_utils/
</div>

<p>Перейдите к комплекту тестов, нажав «Test Suite» на боковой панели Futon, затем нажмите «Run all» в верхней части, чтобы начать работу. <a href="#figure/2"> Рисунок 2, «Набор тестов Futon, в котором выполняются некоторые тесты» </a> показывает набор тестов Futon, в котором выполняются некоторые тесты.
<div class="figure" id="figure/2">

<img src="tour/02.png">

<p class="caption">Figure 2. Работа набора тестов Futon

</div>

<p>Поскольку набор тестов запускается из браузера, он не только проверяет правильность работы CouchDB, но также проверяет, правильно ли настроено подключение вашего браузера к базе данных, что может быть очень удобно для диагностики некорректно работающих прокси-серверов или другого промежуточного ПО HTTP.
<div class="aside warning">

<p>
Если в тестовом наборе слишком много сбоев, вам нужно посетить раздел устранения неполадок на странице <a href="source.html"> Приложения D, Установка из источника </a>, чтобы узнать что сделать, чтобы исправить установки СУБД.
</div>

<p>Теперь, когда тестовый набор закончен, вы убедились, что ваша установка CouchDB прошла успешно, и вы готовы увидеть, что еще может предложить Futon.
<h3 id="first">Ваша первая база данных CouchDB и документ</h3>

<p>Создать базу данных в Futon просто. На странице обзора нажмите «Создать базу данных». При запросе имени введите <code>hello-world</code> и нажмите кнопку «Создать».
<p>После того, как ваша база данных будет создана, Futon отобразит список всех ее документов. Этот список сначала будет пустым (<a href="#figure/3"> Рисунок 3, «Пустая база данных в Futon» </a>), поэтому давайте создадим наш первый документ. Нажмите ссылку «Создать документ», а затем кнопку «Создать» во всплывающем окне. Не забудьте оставить идентификатор документа пустым, и CouchDB сгенерирует UUID для вас.
<div class="aside warning">

<p>Для демонстрационных целей хорошо, когда CouchDB назначает UUID. Но в реальной работе мы рекомендуем вам сомостоятельно назначать ваши собственные UUID. Это необходимо для предотвращения создания дубликатов документов.
</div>

<p>Futon отобразит вновь созданный документ с его <code>_id</code> и <code>_rev</code> в качестве единственных полей. Чтобы создать новое поле, нажмите кнопку «Добавить поле». Мы назовем новое поле <code>hello</code>. Нажмите зеленый значок галочки (или нажмите клавишу Enter), чтобы завершить создание поля <code>hello</code>. Дважды щелкните значение поля <code>hello</code> (по умолчанию <code>null</code>), чтобы изменить его.
<p>Если вы попытаетесь ввести <code>world</code> в качестве нового значения, вы получите сообщение об ошибке, когда нажмете на зеленый значок галочки значения. Значения CouchDB должны быть введены как допустимый JSON. Вместо этого введите <code>"world"</code> (с кавычками), потому что это допустимая строка JSON. У вас не должно быть проблем с его сохранением. Вы можете экспериментировать с другими значениями JSON; например, <code>[1, 2, "c"]</code> или <code>{"foo": "bar"}</code>. После того, как вы ввели свои значения в документ, атрибут <code>_rev</code> изменит своё значение. Далее нажмите «Сохранить документ». Результат должен выглядеть следующим образом: <a href="#figure/4"> Рисунок 4, «Привет мир» документ на Futon</a>.
<div class="figure" id="figure/3">

<img src="tour/03.png">

<p class="caption">Figure 3. Вид пустой базы данных на Futon

</div>

<div class="figure" id="figure/4">

<img src="tour/04.png">

<p class="caption">Figure 4. «Привет мир» документ на Futon

</div>

<p>Вы, наверное, заметите, что значение поля <code>_rev</code> документа изменилось. Мы поговорим об этом подробнее в следующих главах, но сейчас важно отметить, что <code>_rev</code> действует как функция безопасности при сохранении документа.
<p>
Futon также предоставляет способ отображения базовых данных JSON, которые могут быть более компактными и удобными для чтения в зависимости от того, с какими данными вы имеете дело. Чтобы увидеть JSON-версию нашего документа «hello world», перейдите на вкладку «Источник». Результат должен выглядеть следующим образом: <a href="#figure/5"> Рисунок 5, «Источник JSON документа« Привет мир »в Futon» </a>.
<div class="figure" id="figure/5">

<img src="tour/05.png">

<p class="caption">Figure 5. Исходные код JSON документа “hello world” на Futon

</div>

<h3 id="mapreduce">Выполнение запросов с помощью MapReduce</h3>

<p>Традиционные реляционные базы данных позволяют вам выполнять любые запросы, если ваши данные структурированы правильно. Напротив, CouchDB использует предопределенные функции <em>map</em> и <em>reduce</em> в стиле, известном как MapReduce. Эти функции обеспечивают большую гибкость, поскольку они могут адаптироваться к изменениям в структуре документа, а индексы для каждого документа могут вычисляться независимо и параллельно. Комбинация карты и функции сокращения в терминологии CouchDB называется <em>view</em>.
<div class="aside note">

<p>Для опытных программистов реляционных баз данных MapReduce может потребовать некоторого привыкания. Вместо того, чтобы объявлять, какие строки из каких таблиц включать в набор результатов, и в зависимости от базы данных определить наиболее эффективный способ выполнения запроса, сокращение запросов основано на простых запросах диапазона к индексам, сгенерированным вашими map-функциями.
</div>

<p>Map-функции вызываются один раз с каждым документом в качестве аргумента. Функция может пропустить документ полностью или <em>выдать</em> одну или несколько строк представления в виде пар ключ / значение. Map-функции могут не зависеть от какой-либо информации за пределами документа. Эта независимость позволяет генерировать представления CouchDB постепенно и параллельно.
<p>Представления CouchDB хранятся в виде строк, отсортированных по ключу. Это делает извлечение данных из ряда ключей эффективным даже при наличии тысяч или миллионов строк. При написании картографических функций CouchDB вашей основной целью является создание индекса, который хранит связанные данные под близлежащими ключами.

<p>Прежде чем мы сможем запустить пример представления MapReduce, нам понадобятся некоторые данные для его запуска. Мы создадим документы, в которых указаны цены на различные товары из супермаркета, которые можно найти в разных магазинах. Давайте создадим документы для яблок, апельсинов и бананов. (Разрешите CouchDB генерировать поля <code>_id</code> и <code>_rev</code>.) Используйте Futon для создания документов, имеющих окончательную структуру JSON, которая выглядит следующим образом:
<pre>
{
    "_id" : "bc2a41170621c326ec68382f846d5764",
    "_rev" : "2612672603",
    "item" : "apple",
    "prices" : {
        "Fresh Mart" : 1.59,
        "Price Max" : 5.99,
        "Apples Express" : 0.79
    }
}
</pre>

<p>Этот документ должен выглядеть следующим образом: <a href="#figure/6"> Рисунок 6, «Пример документа с ценами на яблоки в Футоне» </a> при вводе в Futon.
<div class="figure" id="figure/6">

<img src="tour/06.png">

<p class="caption">Рисунок 6. Пример документа с ценами на яблоки в Futon

</div>

<p>OХорошо, теперь, когда это сделано, давайте создадим документ для апельсинов:
<pre>
{
    "_id" : "bc2a41170621c326ec68382f846d5764",
    "_rev" : "2612672603",
    "item" : "orange",
    "prices" : {
        "Fresh Mart" : 1.99,
        "Price Max" : 3.19,
        "Citrus Circus" : 1.09
    }
}
</pre>

<p>И наконец, документ для бананов:

<pre>
{
    "_id" : "bc2a41170621c326ec68382f846d5764",
    "_rev" : "2612672603",
    "item" : "banana",
    "prices" : {
        "Fresh Mart" : 1.99,
        "Price Max" : 0.79,
        "Banana Montana" : 4.22
    }
}
</pre>

<p>Представьте, что мы готовим большой обед, но клиент очень чувствителен к цене. Чтобы найти самые низкие цены, мы собираемся создать наш первый вид, который показывает каждый фрукт, отсортированный по цене. Нажмите «hello-world», чтобы вернуться в экрану базы данных «hello-world», а затем в меню «select view» выберите «Temporary view…», чтобы создать новый вид. Результат должен выглядеть примерно так: <a href="#figure/7"> Рисунок 7, «Временное представление в Futon» </a>.
<div class="figure" id="figure/7">

<img src="tour/07.png">

<p class="caption">Рисунок 7, Временное представление в Futon

</div>

<p>Отредактируйте функцию карты слева, чтобы она выглядела следующим образом:

<pre>
function(doc) {
    var store, price, value;
    if (doc.item &amp;&amp; doc.prices) {
        for (store in doc.prices) {
            price = doc.prices[store];
            value = [doc.item, store];
            emit(price, value);
        }
    }
}
</pre>

<p>Это функция <em>JavaScript</em>, которую CouchDB запускает для каждого из наших документов при вычислении представления. Мы пока оставляем функцию открытой пустой.
<p>Нажмите «Выполнить», и вы увидите строки результатов, как на <a href="#figure/8"> Рис. 8, «Результаты запуска представления в Futon»</a>, с различными элементами, отсортированными по цене. Эта функция карты могла бы быть еще более полезной, если бы она сгруппировала элементы по типу так, чтобы все цены на бананы были рядом друг с другом в наборе результатов. Система сортировки ключей CouchDB позволяет использовать любой допустимый объект JSON в качестве ключа. В этом случае мы создадим массив <code>[item, price]</code>, чтобы CouchDB группировался по типу и цене.
<div class="figure" id="figure/8">

<img src="tour/08.png">

<p class="caption">Рисунок 8. Результат выполнения запроса в Futon

</div>

<p>Давайте изменим функцию представления так, чтобы она выглядела так:

<pre>
function(doc) {
    var store, price, key;
    if (doc.item &amp;&amp; doc.prices) {
        for (store in doc.prices) {
            price = doc.prices[store];
            key = [doc.item, price];
            emit(key, store);
        }
    }
}
</pre>

<p>Здесь мы сначала проверяем, есть ли в документе поля, которые мы хотим использовать. CouchDB изящно восстанавливается после нескольких изолированных ошибок map-функции, но когда map-функция регулярно выходит из строя (из-за пропуска обязательного поля или другого исключения JavaScript), CouchDB отключает свою индексацию, чтобы предотвратить дальнейшее использование ресурса. По этой причине важно проверить наличие каких-либо полей, прежде чем использовать их. В этом случае наша функция карты пропустит первый созданный нами документ «hello world», не создавая строк и не обнаруживая ошибок. Результат этого запроса должен выглядеть следующим образом: <a href="#figure/9"> Рисунок 9, «Результаты запуска представления после группировки по типу элемента и цене» </a>.
<div class="figure" id="figure/9">

<img src="tour/09.png">

<p class="caption">Рисунок 9, Результаты запуска представления после группировки по типу элемента и цене

</div>

<p>Как только мы узнаем, что получили документ с типом элемента и некоторыми ценами, мы перебираем цены элемента и генерируем пары ключ / значение. Ключ является массивом товара и цены и служит основой для отсортированного индекса CouchDB. В этом случае значением является название магазина, в котором товар можно найти по указанной цене.
<p>Строки представления сортируются по их ключам - в этом примере сначала по элементу, а затем по цене. Этот метод сложной сортировки лежит в основе создания полезных индексов с помощью CouchDB.
<div class="aside note">

<p>MapReduce может быть сложной задачей, особенно если вы потратили годы на работу с реляционными базами данных. Важно помнить, что функции карт дают вам возможность сортировать данные с использованием любой выбранной вами клавиши, а дизайн CouchDB ориентирован на обеспечение быстрого и эффективного доступа к данным в пределах диапазона клавиш.
</div>

<h3 id="replication">Запуск репликации</h3>

<p>Futon может запускать репликацию между двумя локальными базами данных, между локальной и удаленной базами данных или даже между двумя удаленными базами данных. Мы покажем вам, как реплицировать данные из одной локальной базы данных в другую, что является простым способом создания резервных копий ваших баз данных, поскольку мы работаем с примерами.
<p>Сначала нам нужно создать пустую базу данных, чтобы стать целью репликации. Вернитесь к обзору и создайте базу данных с именем <code>hello-replication</code>. Теперь нажмите «Replicator» на боковой панели и выберите <code>hello-world</code> в качестве источника и <code>hello-replication</code> в качестве цели. Нажмите «Реплицировать», чтобы скопировать вашу базу данных. Результат должен выглядеть примерно так: <a href="#figure/10"> Рисунок 10, «Запуск репликации базы данных в Futon» </a>.
<div class="figure" id="figure/10">

<img src="tour/10.png">

<p class="caption">Рисунок 10, Запуск репликации базы данных в Futon

</div>

<div class="aside warning">

<p>Для больших баз данных репликация может занять гораздо больше времени. Во время репликации важно оставить окно браузера открытым. В качестве альтернативы вы можете запустить репликацию через <code>curl</code> или другой HTTP-клиент, который может обрабатывать долго работающие соединения. Если ваш клиент закрывает соединение до завершения репликации, вам придется выполнить повторную проверку. К счастью, репликация CouchDB может начать с того места, где она остановилась, вместо того, чтобы начинать с нуля.
</div>

<h3 id="wrap">Заключение</h3>

<p>Теперь, когда вы ознакомились с большинством функций Futon, вы будете готовы погрузиться и проверить свои данные, когда мы создадим наше пример приложения в следующих нескольких главах. Чистый JavaScript-подход Futon к управлению CouchDB показывает, как можно создать полнофункциональное веб-приложение, используя только HTTP-интерфейс CouchDB и встроенный веб-сервер.

<p>But before we get there, we’ll have another look at CouchDB’s HTTP API—now with a magnifying glass. Let’s <em>curl</em> on the couch and relax.
Но прежде чем мы доберемся до этого, мы еще раз взглянем на HTTP API CouchDB - теперь более детально. Давайте <em>curl</em> на диване и расслабимся.